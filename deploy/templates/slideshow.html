<!DOCTYPE html>
<html>
<head>
    <title>PiFrame Slideshow</title>
    <meta charset="UTF-8">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 1920px;
            height: 1080px;
            background: #000;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            cursor: none;
        }

        .slideshow-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 1920px;
            height: 1080px;
            background: #000;
        }

        .slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 1920px;
            height: 1080px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            opacity: 0;
            transition: opacity 1s ease-in-out;
        }

        .slide.active {
            opacity: 1;
            z-index: 2;
        }

        .slide img {
            width: 1920px;
            height: 1080px;
            object-fit: cover;
            object-position: center;
        }
        
        /* Status overlay (optional) */
        .status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            color: #fff;
            background: rgba(0,0,0,0.5);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .status.show {
            opacity: 1;
        }
    </style>
</head>
<body style="margin:0;padding:0;background:#000;width:1920px;height:1080px;overflow:hidden">
    <div class="slideshow-container">
    </div>
    <div class="status" id="status"></div>
    
    <script>
        const config = {
            delay: {{ config.delay }} * 1000,
            randomize: {{ 'true' if config.randomize else 'false' }},
            transitionDuration: {{ config.transition_duration }} * 1000
        };
        
        let photos = [];
        let currentIndex = 0;
        let slideInterval;
        const container = document.querySelector('.slideshow-container');
        const status = document.getElementById('status');
        
        // Fetch photo list
        async function loadPhotos() {
            try {
                const response = await fetch('/api/photos');
                photos = await response.json();
                
                if (config.randomize) {
                    shuffleArray(photos);
                }
                
                if (photos.length > 0) {
                    initSlideshow();
                } else {
                    showStatus('No photos found');
                }
            } catch (error) {
                showStatus('Error loading photos: ' + error.message);
            }
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        async function initSlideshow() {
            // Preload first three images - wait for first to fully load
            await createSlide(0);

            // Wait a bit to ensure image is rendered
            await new Promise(resolve => setTimeout(resolve, 100));

            // Start loading additional images
            if (photos.length > 1) {
                createSlide(1);
            }
            if (photos.length > 2) {
                createSlide(2);
            }

            // Start slideshow after first image is loaded and rendered
            showSlide(0);
            startSlideshow();
        }
        
        function createSlide(index) {
            const slide = document.createElement('div');
            slide.className = 'slide';
            slide.dataset.index = index;

            const img = document.createElement('img');

            // Preload image before adding to DOM
            return new Promise((resolve, reject) => {
                img.onload = () => {
                    slide.appendChild(img);
                    container.appendChild(slide);
                    resolve(slide);
                };
                img.onerror = () => {
                    console.error('Failed to load image:', photos[index]);
                    reject();
                };
                img.src = `/photos/${encodeURIComponent(photos[index])}`;
            });
        }
        
        async function showSlide(index) {
            // Get the new slide (create if needed)
            let slide = container.querySelector(`[data-index="${index}"]`);
            if (!slide) {
                slide = await createSlide(index);
            }

            // Activate the new slide (will cross-fade)
            const slides = container.querySelectorAll('.slide');
            slide.classList.add('active');
            currentIndex = index;

            // After transition completes, remove active from old slides
            setTimeout(() => {
                slides.forEach(s => {
                    if (s !== slide) {
                        s.classList.remove('active');
                    }
                });
            }, config.transitionDuration);

            // Preload next two images
            const nextIndex = (index + 1) % photos.length;
            const nextNextIndex = (index + 2) % photos.length;

            if (!container.querySelector(`[data-index="${nextIndex}"]`)) {
                createSlide(nextIndex);
            }
            if (!container.querySelector(`[data-index="${nextNextIndex}"]`)) {
                createSlide(nextNextIndex);
            }

            // When near the end, preload first images for smooth loop
            if (index >= photos.length - 3) {
                for (let i = 0; i < 3; i++) {
                    if (!container.querySelector(`[data-index="${i}"]`)) {
                        createSlide(i);
                    }
                }
            }
        }
        
        function nextSlide() {
            showSlide((currentIndex + 1) % photos.length);
        }

        function startSlideshow() {
            slideInterval = setInterval(nextSlide, config.delay);
        }

        function showStatus(message) {
            status.textContent = message;
            status.classList.add('show');
            setTimeout(() => status.classList.remove('show'), 3000);
        }

        // Cleanup old slides to prevent memory leak - keep more slides cached
        function cleanupSlides() {
            const slides = container.querySelectorAll('.slide');
            if (slides.length > 8) {
                slides.forEach((slide) => {
                    const slideIndex = parseInt(slide.dataset.index);
                    const currentIdx = currentIndex;
                    const nextIdx = (currentIndex + 1) % photos.length;
                    const nextNextIdx = (currentIndex + 2) % photos.length;

                    // Always keep first 3 slides for smooth looping
                    if (slideIndex < 3) {
                        return;
                    }

                    // Keep current and next 2 slides
                    if (slideIndex !== currentIdx &&
                        slideIndex !== nextIdx &&
                        slideIndex !== nextNextIdx &&
                        !slide.classList.contains('active')) {
                        slide.remove();
                    }
                });
            }
        }

        // Clean up every 3 minutes
        setInterval(cleanupSlides, 180000);

        // Initialize on page load
        loadPhotos();
    </script>
</body>
</html>