<!DOCTYPE html>
<html>
<head>
    <title>PiFrame Slideshow</title>
    <meta charset="UTF-8">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 1920px;
            height: 1080px;
            background: #000;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            cursor: none;
        }

        .slideshow-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 1920px;
            height: 1080px;
            background: #000;
        }
        
        .slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 1920px;
            height: 1080px;
            opacity: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .slide.active {
            opacity: 1;
            z-index: 2;
        }
        
        .slide img {
            width: 1920px;
            height: 1080px;
            object-fit: cover;
            object-position: center;
        }

        /* Cross-fade transition - always fade opacity */
        .slide {
            transition: opacity 1.5s ease-in-out;
        }

        .slide.active {
            transition: opacity 1.5s ease-in-out;
        }

        /* Zoom effect on images during display */
        .transition-zoom .slide.active img {
            animation: zoom-in 10s ease-in-out forwards;
        }

        @keyframes zoom-in {
            0% {
                transform: scale(1);
            }
            100% {
                transform: scale(1.15);
            }
        }

        /* Fade with subtle zoom */
        .transition-fade .slide.active img {
            animation: fade-zoom 10s ease-in-out forwards;
        }

        @keyframes fade-zoom {
            0% {
                transform: scale(1);
            }
            100% {
                transform: scale(1.08);
            }
        }

        /* Slide transition with cross-fade */
        .transition-slide .slide.active img {
            animation: slide-zoom 10s ease-in-out forwards;
        }

        @keyframes slide-zoom {
            0% {
                transform: scale(1.05) translateX(-2%);
            }
            100% {
                transform: scale(1.15) translateX(2%);
            }
        }

        /* Ken Burns effect - enhanced for full-screen */
        .kenburns .slide.active img {
            animation: kenburns 10s ease-in-out forwards;
        }

        @keyframes kenburns {
            0% {
                transform: scale(1) translate(0, 0);
            }
            100% {
                transform: scale(1.15) translate(-3%, -3%);
            }
        }

        /* Alternate Ken Burns animations */
        .kenburns .slide:nth-child(even).active img {
            animation: kenburns-alt 10s ease-in-out forwards;
        }

        @keyframes kenburns-alt {
            0% {
                transform: scale(1.15) translate(3%, 3%);
            }
            100% {
                transform: scale(1) translate(0, 0);
            }
        }
        
        /* Status overlay (optional) */
        .status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            color: #fff;
            background: rgba(0,0,0,0.5);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .status.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="slideshow-container transition-{{ config.transition }}{% if config.kenburns %} kenburns{% endif %}">
    </div>
    <div class="status" id="status"></div>
    
    <script>
        const config = {
            delay: {{ config.delay }} * 1000,
            randomize: {{ 'true' if config.randomize else 'false' }},
            transition: '{{ config.transition }}',
            transitionDuration: {{ config.transition_duration }} * 1000,
            kenburns: {{ 'true' if config.kenburns else 'false' }}
        };
        
        let photos = [];
        let currentIndex = 0;
        let slideInterval;
        const container = document.querySelector('.slideshow-container');
        const status = document.getElementById('status');
        
        // Fetch photo list
        async function loadPhotos() {
            try {
                const response = await fetch('/api/photos');
                photos = await response.json();
                
                if (config.randomize) {
                    shuffleArray(photos);
                }
                
                if (photos.length > 0) {
                    initSlideshow();
                } else {
                    showStatus('No photos found');
                }
            } catch (error) {
                showStatus('Error loading photos: ' + error.message);
            }
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        function initSlideshow() {
            // Preload first two images
            createSlide(0);
            if (photos.length > 1) {
                createSlide(1);
            }
            
            // Start slideshow
            setTimeout(() => {
                showSlide(0);
                startSlideshow();
            }, 100);
        }
        
        function createSlide(index) {
            const slide = document.createElement('div');
            slide.className = 'slide';
            slide.dataset.index = index;
            
            const img = document.createElement('img');
            img.src = `/photos/${encodeURIComponent(photos[index])}`;
            img.onerror = () => nextSlide();
            
            slide.appendChild(img);
            container.appendChild(slide);
            return slide;
        }
        
        function showSlide(index) {
            // Get the new slide (create if needed)
            let slide = container.querySelector(`[data-index="${index}"]`);
            if (!slide) slide = createSlide(index);

            // Set z-index for proper layering (new slide on top)
            const slides = container.querySelectorAll('.slide');
            slides.forEach(s => {
                if (s === slide) {
                    s.style.zIndex = 2;
                } else if (s.classList.contains('active')) {
                    s.style.zIndex = 1;
                } else {
                    s.style.zIndex = 0;
                }
            });

            // Activate the new slide (will cross-fade over the old one)
            slide.classList.add('active');
            currentIndex = index;

            // After transition completes, remove active from old slides
            setTimeout(() => {
                slides.forEach(s => {
                    if (s !== slide) {
                        s.classList.remove('active');
                    }
                });
            }, config.transitionDuration);

            // Preload next image
            const nextIndex = (index + 1) % photos.length;
            if (!container.querySelector(`[data-index="${nextIndex}"]`)) {
                createSlide(nextIndex);
            }
        }
        
        function nextSlide() {
            showSlide((currentIndex + 1) % photos.length);
        }

        function startSlideshow() {
            slideInterval = setInterval(nextSlide, config.delay);
        }

        function showStatus(message) {
            status.textContent = message;
            status.classList.add('show');
            setTimeout(() => status.classList.remove('show'), 3000);
        }

        // Cleanup old slides to prevent memory leak
        function cleanupSlides() {
            const slides = container.querySelectorAll('.slide');
            if (slides.length > 3) {
                slides.forEach((slide, index) => {
                    if (!slide.classList.contains('active') &&
                        slide.dataset.index != currentIndex &&
                        slide.dataset.index != ((currentIndex + 1) % photos.length)) {
                        slide.remove();
                    }
                });
            }
        }

        // Clean up every minute
        setInterval(cleanupSlides, 60000);

        // Initialize on page load
        loadPhotos();
    </script>
</body>
</html>